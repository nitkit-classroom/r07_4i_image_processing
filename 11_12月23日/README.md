# Chapter9　2値化

---

# 今日の目標
- 2値化が何か分かる
- 2値化の手法がいくつか分かる
	- p-タイル法
	- モード法
	- 判別分析法（大津の方法）

---

# 9-1 2値化（教科書に無し）
2値化は，画像中の画素値を **0/1（黒/白）** の2値に置き換える処理で，次の目的で使われる

- **対象と背景を分けて扱えるようにする**  
    物体（文字・部品・細胞など）だけを抽出しやすくなる
- **後段の処理を簡単に・速くする**  
    ラベリング（連結成分解析）、輪郭抽出、面積計測などがやりやすく、計算も軽くなる
- **ノイズや濃淡の揺れに強い表現にする**  
    濃淡の微妙な差を捨てて「ある／ない」に落とすことで、必要な情報だけ残す設計ができる
- **特徴量や判定ルールを作りやすい**  
    面積・周長・重心・穴の数など、形状ベースの指標が取りやすい。判定も閾値やルールで組みやすい

---

- **2値画像**は，たとえばある値以上の画素値を1（白画素）に，それ未満の画素値を0（黒画素）に変換することにより得られる
- この値を閾値（しきいち；threshold）とよび，この変換を**閾値処理**とよぶ
- グレースケール画像の中間値をなくし，閾値処理により白または黒（1または0）の2値の画像に変換することを**2値化**とよぶ

【注意】2値化は情報を大きく捨てるので， **閾値の選び方** が結果を強く左右する。

---

#  2値化手法について
今回は3手法を紹介する
- **p-タイル法**  
    「画像中の対象（前景）が全体の _p%_ を占める」という事前知識を使う手法。濃度ヒストグラムを暗い側（または明るい側）から累積し、累積割合が _p_ になる画素値をしきい値にする。
- **モード法**  
    ヒストグラムが2峰性（背景と対象で山が2つ）になることを仮定し、2つのピーク（モード）の間の谷（頻度が最小になるあたり）をしきい値として選ぶ。
- **判別分析法（大津の方法）**  
    しきい値で画素を2クラスに分けたとき、**クラス間分散が最大**（同値に **クラス内分散が最小**）となるしきい値を全探索で求める。事前知識なしで自動的に決められる代表的手法。

---

## 9-1-2 p-タイル法
画像中の"黒領域"対象が全体の何%（p%）を占めるのか分かっている場合に使用できる手法

**処理フロー**

0. 画像をグレースケール化する
1. 画像のヒストグラムを作成する（どの値を持っている画素が，それぞれいくつあるか数える）
2. パーセンテージを元に，どの値まで1，どの値から0にするか決める
3. 実際に画素を1か0に置き換える
  
---

![](materials/Pasted%20image%2020251223101337.png)

---
### 開発手順書
1. 画像を読み出すコードの作成（OpenCV関数使用可能）
2. 画像をグレースケールに変換するコードの作成（OpenCV関数使用可）
3. 画像のヒストグラムを作成するコードの作成（リストをうまく使う・2重for文）
4. パーセンテージから，閾値を決める処理を追加
5. 閾値から，画像を2値（0か1か）に置換する処理の追加
6. 画像全体を255倍にする処理の追加
7. 画像を保存するコードの作成（OpenCV関数使用可能）

---

## 9-1-3 モード法
- 一般に,文書のような白黒画像の画素値のヒストグラムは,図9.1に示すような2つの山をもつことが多い。
- モード法 (mode method) は,山と山の間の谷が2つを分離するよい手がかりと考え,その谷の底をしきい値とする
- しかし,この方法は,画像に十分な画素数がないとノイズによって山や谷がはっきりと現れないため,谷の底を自動かつ安定に検出することが困難になり,目的に応じて工夫する必要がある

---

## 9-1-4 判別分析法

黒画素クラスに属する画素と白画素クラスに属する画素は,図9.9において，あるしきい値tの左右で分かれて分布するが,その分布の分離度が大きくなるようにしきい値tを決める方法が判別分析法(discriminant analysis method)である。

---

![](materials/Pasted%20image%2020251223105608.png)

---

![](materials/Pasted%20image%2020251223105623.png)

---
### 判別分析法の処理フロー

0. グレースケール化（必要なら）
1. ヒストグラム作成（輝度0〜255の出現数）
2. 閾値 T を全探索（Tを0〜255に変化させるfor文を作成する）
	- 2.1 画像の全ての画素を順番に選択する（2重for文）
		- 2.1.1 選んだ画素がクラス0かクラス1か調べる（if文）
		    - クラス0：0 ～ T
			    - クラス0のカウンタの数を1増やす
			    - クラス0の総合計を求める変数に，画素の値を加算する
		    - クラス1：T+1 ～ 255
			    - クラス1のカウンタの数を1増やす
			    - クラス1の総合計を求める変数に，画素の値を加算する
	- 2.2 クラス0・クラス1の画素の平均値を求める
	- 2.3 クラス間分散 $\sigma^2_B (T)$ を計算する
3. 閾値Tがどのときに，クラス間分散が最大だったか調べる
4. 決めた閾値Tで2値化する

---
### 判別分析法におけるクラス間分散の求め方
 
 $$
 \sigma^2_B (T) = p_0(T) p_1(T) ( \mu_0(T) - \mu_1(T) )^2
 $$
 
 ただし
 - $p_0$ : クラス0の画素の割合（閾値以下の画素の数を，全ての画素数で割ったもの）
 - $p_1$ : クラス1の画素の割合（閾値を超える画素の数を，全ての画素数で割ったもの）
 - $\mu_0$ : クラス0の画素の平均値
 - $\mu_1$ : クラス1の画素の平均値

これが最も大きいものを選ぶ

---

# 課題
[ptile.py](work/ptile.py)を改造して，判別分析法を実装せよ
- 実行コマンドは次の通り
	- 凡例：python <プログラム名> <入力画像ファイル名>
	- サンプル：python hanbetsu.py test.jpg
- 出力ファイル名は`output.png`とすること
- 拡張子を「.py」から「.txt」へリネームして提出すること